<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smartlibrary.dao.definedSearchDao">
    <!--24小时刷新-->
    <cache flushInterval="86400000"/>
    <!--借书-->
    <sql id="getDefinedBook0">
        SELECT count(*) AS amount,DATE_FORMAT(z.operation_time, '%Y/%m/%d') AS time
        FROM   z_book_lend_sys AS z
        WHERE (z.operation_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != '' and academy != '所有'">
            AND z.`reader_academy` in
            <foreach collection="academyList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="student_style != null and student_style != '' and student_style != '所有'">
            AND z.`reader_identity` in
            <foreach collection="student_styleList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`reader_gender` = #{student_sex}
        </if>
        <if test="publisher != null and publisher != '' and publisher != '所有'">
            AND z.`book_publisher` in
            <foreach collection="publisherList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="book_style != null and book_style != '' and book_style != '所有'">
            AND z.`book_category` in
            <foreach collection="book_styleList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        GROUP BY time
        ORDER BY time
    </sql>
    <!--还书-->
    <sql id="getDefinedBook1">
        SELECT count(*) AS amount,DATE_FORMAT(z.operation_time, '%Y/%m/%d') AS time
        FROM   z_book_back_sys AS z
        WHERE (z.operation_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != '' and academy != '所有'">
            AND z.`reader_academy` in
            <foreach collection="academyList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="student_style != null and student_style != '' and student_style != '所有'">
            AND z.`reader_identity` in
            <foreach collection="student_styleList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`reader_gender` = #{student_sex}
        </if>
        <if test="publisher != null and publisher != '' and publisher != '所有'">
            AND z.`book_publisher` in
            <foreach collection="publisherList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="book_style != null and book_style != '' and book_style != '所有'">
            AND z.`book_category` in
            <foreach collection="book_styleList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        GROUP BY time
        ORDER BY time
    </sql>
    <!--续借-->
    <sql id="getDefinedBook2">
        SELECT count(*) AS amount,DATE_FORMAT(z.operation_time, '%Y/%m/%d') AS time
        FROM   z_book_renew_sys AS z
        WHERE (z.operation_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != '' and academy != '所有'">
            AND z.`reader_academy` in
            <foreach collection="academyList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="student_style != null and student_style != '' and student_style != '所有'">
            AND z.`reader_identity` in
            <foreach collection="student_styleList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`reader_gender` = #{student_sex}
        </if>
        <if test="publisher != null and publisher != '' and publisher != '所有'">
            AND z.`book_publisher` in
            <foreach collection="publisherList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        <if test="book_style != null and book_style != '' and book_style != '所有'">
            AND z.`book_category` in
            <foreach collection="book_styleList" open="(" close=")" separator="," item="item" index="i">
                #{item}
            </foreach>
        </if>
        GROUP BY time
        ORDER BY time
    </sql>
    <!--借阅统计-->
    <select id="getDefinedBook" parameterType="com.smartlibrary.domain.DefinedBookSearch" resultType="com.smartlibrary.domain.DefinedResult">
        SELECT SUM(zz.amount) amount,zz.time
        FROM
        <trim prefix="(" prefixOverrides="UNION ALL" suffix=")">
            <choose>
                <when test="lend_style != null and lend_style != '' and lend_style != '所有'">
                    <if test="@com.smartlibrary.common.SqlTestHelp@isInList('0',lend_styleList)">
                        UNION ALL (<include refid="getDefinedBook0"></include>)
                    </if>
                    <if test="@com.smartlibrary.common.SqlTestHelp@isInList('1',lend_styleList)">
                        UNION ALL (<include refid="getDefinedBook1"></include>)
                    </if>
                    <if test="@com.smartlibrary.common.SqlTestHelp@isInList('2',lend_styleList)">
                        UNION ALL (<include refid="getDefinedBook2"></include>)
                    </if>
                </when>
                <otherwise>
                    UNION ALL (<include refid="getDefinedBook0"></include>)
                    UNION ALL (<include refid="getDefinedBook1"></include>)
                    UNION ALL (<include refid="getDefinedBook2"></include>)
                </otherwise>
            </choose>
        </trim>
        AS zz
        GROUP BY zz.time
        ORDER BY zz.time
    </select>

    <!--进馆总数统计-->
    <sql id="getDefinedGctrl_Number">
        SELECT count(*) AS amount,DATE_FORMAT(z.enter_time, '%Y/%m/%d') AS time
        FROM z_gctrl_ctrl_sys as z
        WHERE (z.enter_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != ''">
            AND z.`academy` = #{academy}
        </if>
        <if test="student_style != null and student_style != ''">
            AND z.`identity` = #{student_style}
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`gender` = #{student_sex}
        </if>
        GROUP BY time
        ORDER BY z.enter_time
    </sql>
    <!--进馆排名-->
    <sql id="getDefinedGctrl_Rank">
        <choose>
            <when test="academy == null or academy == ''">
                <include refid="getDefinedGctrlRankOfAcademy"></include>
            </when>
            <otherwise>
                <choose>
                    <when test="student_style == null or student_style == ''">
                        <include refid="getDefinedGctrlRankOfStyle"></include>
                    </when>
                    <otherwise>
                        <choose>
                            <when test="student_sex == null or student_sex == ''">
                                <include refid="getDefinedGctrlRankOfSex"></include>
                            </when>
                            <otherwise>
                                <include refid="getDefinedGctrlRankOfOneSex"></include>
                            </otherwise>
                        </choose>
                    </otherwise>
                </choose>
            </otherwise>
        </choose>
    </sql>
    <!--进馆按学院排名-->
    <sql id="getDefinedGctrlRankOfAcademy">
        SELECT z.`academy` AS academy,count(*) AS amount
        FROM z_gctrl_ctrl_sys as z
        WHERE (z.enter_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != ''">
            AND z.`academy` = #{academy}
        </if>
        <if test="student_style != null and student_style != ''">
            AND z.`identity` = #{student_style}
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`gender` = #{student_sex}
        </if>
        GROUP BY z.`academy`
        ORDER BY amount DESC
        LIMIT 10
    </sql>
    <!--进馆按学生类别排名-->
    <sql id="getDefinedGctrlRankOfStyle">
        SELECT z.`identity` AS academy,count(*) AS amount
        FROM z_gctrl_ctrl_sys as z
        WHERE (z.enter_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != ''">
            AND z.`academy` = #{academy}
        </if>
        <if test="student_style != null and student_style != ''">
            AND z.`identity` = #{student_style}
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`gender` = #{student_sex}
        </if>
        GROUP BY z.`identity`
        ORDER BY amount DESC
        LIMIT 10
    </sql>
    <!--进馆按学生性别排名-->
    <sql id="getDefinedGctrlRankOfSex">
        SELECT z.`gender` AS academy,count(*) AS amount
        FROM z_gctrl_ctrl_sys as z
        WHERE (z.enter_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != ''">
            AND z.`academy` = #{academy}
        </if>
        <if test="student_style != null and student_style != ''">
            AND z.`identity` = #{student_style}
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`gender` = #{student_sex}
        </if>
        GROUP BY z.`gender`
        ORDER BY amount DESC
        LIMIT 10
    </sql>
    <!--进馆按学生性别之一排名-->
    <sql id="getDefinedGctrlRankOfOneSex">
        SELECT z.`gender` AS academy,count(*) AS amount
        FROM z_gctrl_ctrl_sys as z
        WHERE (z.enter_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != ''">
            AND z.`academy` = #{academy}
        </if>
        <if test="student_style != null and student_style != ''">
            AND z.`identity` = #{student_style}
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`gender` = #{student_sex}
        </if>
        GROUP BY z.`gender`
        ORDER BY amount DESC
    </sql>
    <!--进馆-->
    <select id="getDefinedGctrl" parameterType="com.smartlibrary.domain.DefinedGctrlSearch" resultType="com.smartlibrary.domain.DefinedResult">
        <choose>
            <when test="style==0">
                <include refid="getDefinedGctrl_Number"></include>
            </when>
            <when test="style==1">
                <include refid="getDefinedGctrl_Rank"></include>
            </when>
            <otherwise>
                <include refid="getDefinedGctrl_Number"></include>
            </otherwise>
        </choose>
    </select>


    <sql id="getDefinedIc0">
        SELECT DATE_FORMAT(zz.ymddate, '%Y/%m/%d') AS time,
        <choose>
            <when test="ic_type == 0 and style==1">
                zz.croom_times
            </when>
            <when test="ic_type == 0 and style==0">
                zz.croom_duration
            </when>
            <when test="ic_type == 1 and style==1">
                zz.seat_times
            </when>
            <when test="ic_type == 1 and style==0">
                zz.seat_duration
            </when>
            <when test="ic_type == 2 and style==1">
                zz.eread_times
            </when>
            <when test="ic_type == 2 and style==0">
                zz.eread_duration
            </when>
            <when test="ic_type == 3 and style==1">
                zz.equipment_times
            </when>
            <when test="ic_type == 3 and style==0">
                zz.equipment_duration
            </when>
            <otherwise>
                zz.croom_times
            </otherwise>
        </choose>
        AS amount
        FROM zz_ic_day_identity as zz
        WHERE (zz.ymddate BETWEEN #{start_time} AND #{end_time})
        AND zz.`user_type` = #{student_style}
        ORDER BY zz.ymddate
    </sql>
    <sql id="getDefinedIc1">
        SELECT DATE_FORMAT(zz.ymddate, '%Y/%m/%d') AS time,
        <choose>
            <when test="ic_type == 0 and style==1">
                SUM(zz.croom_times)
            </when>
            <when test="ic_type == 0 and style==0">
                SUM(zz.croom_duration)
            </when>
            <when test="ic_type == 1 and style==1">
                SUM(zz.seat_times)
            </when>
            <when test="ic_type == 1 and style==0">
                SUM(zz.seat_duration)
            </when>
            <when test="ic_type == 2 and style==1">
                SUM(zz.eread_times)
            </when>
            <when test="ic_type == 2 and style==0">
                SUM(zz.eread_duration)
            </when>
            <when test="ic_type == 3 and style==1">
                SUM(zz.equipment_times)
            </when>
            <when test="ic_type == 3 and style==0">
                SUM(zz.equipment_duration)
            </when>
            <otherwise>
                SUM(zz.croom_times)
            </otherwise>
        </choose>
        AS amount
        FROM zz_ic_day_identity as zz
        WHERE (zz.ymddate BETWEEN #{start_time} AND #{end_time})
        GROUP BY time
        ORDER BY zz.ymddate
    </sql>
    <!--IC-->
    <select id="getDefinedIc" parameterType="com.smartlibrary.domain.DefinedIcSearch" resultType="com.smartlibrary.domain.DefinedResult">
        <choose>
            <when test="student_style != null and student_style != ''">
                <include refid="getDefinedIc0"></include>
            </when>
            <otherwise>
                <include refid="getDefinedIc1"></include>
            </otherwise>
        </choose>
    </select>

    <!--打印复印-->
    <select id="getDefinedPrint" parameterType="com.smartlibrary.domain.DefinedPrintSearch" resultType="com.smartlibrary.domain.DefinedResult">
        SELECT count(*) AS amount,DATE_FORMAT(z.print_time, '%Y/%m/%d') AS time
        FROM z_printcs_sys AS z
        WHERE (z.print_time BETWEEN #{start_time} AND #{end_time})
        <if test="print_type != null and print_type != ''">
            AND z.`print_type` = #{print_type}
        </if>
        <if test="print_location != null and print_location != ''">
            AND z.`print_location` = #{print_location}
        </if>
        <if test="paper_type != null and paper_type != ''">
            AND z.`paper_type` = #{paper_type}
        </if>
        GROUP BY time
        ORDER BY z.print_time
    </select>

    <!--人员-->
    <sql id="getDefinedPerson">
        SELECT DATE_FORMAT(dwBirthDate, '%Y') AS year,COUNT(*) AS amount
        FROM app_employee
        WHERE (DATE_FORMAT(dwBirthDate, '%Y') BETWEEN #{birth_start} AND #{birth_end})
        <if test="sex != null and sex != ''">
            AND dwSex = #{sex}
        </if>
        <if test="profession != null and profession != ''">
            AND dwjobTitle = #{profession}
        </if>
        GROUP BY year
        ORDER BY year
    </sql>
    <!--资产-设备-->
    <sql id="getDefinedAsset0">
        SELECT DATE_FORMAT(dwPurchaseDate, '%Y') AS year,COUNT(*) AS amount
        FROM app_baseinfo
        WHERE (DATE_FORMAT(dwPurchaseDate, '%Y') BETWEEN #{birth_start} AND #{birth_end})
        GROUP BY year
        ORDER BY year
    </sql>
    <!--资产-馆藏资源-->
    <sql id="getDefinedAsset1">
        SELECT year AS year,count AS amount
        FROM app_resources
        WHERE (year BETWEEN #{birth_start} AND #{birth_end})
        GROUP BY year
        ORDER BY year
    </sql>
    <!--人员资产-->
    <select id="getDefinedPersonAsset" parameterType="com.smartlibrary.domain2.DefinedPersonAssetSearch" resultType="com.smartlibrary.domain.DefinedResult">
        <choose>
            <when test="style==0">
                <include refid="getDefinedPerson"></include>
            </when>
            <when test="style==1">
                <choose>
                    <when test="asset_type==0">
                        <include refid="getDefinedAsset0"></include>
                    </when>
                    <when test="asset_type==1">
                        <include refid="getDefinedAsset1"></include>
                    </when>
                    <otherwise>
                        <include refid="getDefinedAsset0"></include>
                    </otherwise>
                </choose>
            </when>
            <otherwise>
                <include refid="getDefinedPerson"></include>
            </otherwise>
        </choose>

    </select>

    <!--借阅排名-->
    <sql id="getDefinedBookRank0">
        SELECT count(*) AS amount,z.`book_name` AS x_data
        FROM z_book_lend_sys AS z
        WHERE (z.operation_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != ''">
            AND z.`reader_academy` = #{academy}
        </if>
        <if test="student_style != null and student_style != ''">
            AND z.`reader_identity` = #{student_style}
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`reader_gender` = #{student_sex}
        </if>
        GROUP BY z.`book_no`
        ORDER BY amount DESC
        LIMIT #{rank_number}
    </sql>
    <sql id="getDefinedBookRank1">
        SELECT count(*) AS amount,z.`reader_name` AS x_data
        FROM z_book_lend_sys AS z
        WHERE (z.operation_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != ''">
            AND z.`reader_academy` = #{academy}
        </if>
        <if test="student_style != null and student_style != ''">
            AND z.`reader_identity` = #{student_style}
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`reader_gender` = #{student_sex}
        </if>
        GROUP BY z.`account`
        ORDER BY amount DESC
        LIMIT #{rank_number}
    </sql>
    <!--进馆排名-->
    <sql id="getDefinedGctrlRank">
        SELECT count(*) AS amount,DATE_FORMAT(z.enter_time, '%Y/%m/%d') AS x_data
        FROM z_gctrl_ctrl_sys AS z
        WHERE (z.enter_time BETWEEN #{start_time} AND #{end_time})
        <if test="academy != null and academy != ''">
            AND z.`academy` = #{academy}
        </if>
        <if test="student_style != null and student_style != ''">
            AND z.`identity` = #{student_style}
        </if>
        <if test="student_sex != null and student_sex != ''">
            AND z.`gender` = #{student_sex}
        </if>
        GROUP BY x_data
        ORDER BY amount DESC
        LIMIT #{rank_number}
    </sql>
    <!--打印复印排名-->
    <sql id="getDefinedPrintRank">
        SELECT count(*) AS amount,DATE_FORMAT(z.print_time, '%Y/%m/%d') AS x_data
        FROM z_printcs_sys AS z
        WHERE (z.print_time BETWEEN #{start_time} AND #{end_time})
        <if test="print_type != null and print_type != ''">
            AND z.`print_type` = #{print_type}
        </if>
        <if test="print_location != null and print_location != ''">
            AND z.`print_location` = #{print_location}
        </if>
        <if test="paper_type != null and paper_type != ''">
            AND z.`paper_type` = #{paper_type}
        </if>
        GROUP BY x_data
        ORDER BY amount DESC
        LIMIT #{rank_number}
    </sql>
    <!--排名统计-->
    <select id="getDefinedRank" parameterType="com.smartlibrary.domain.DefinedRankSearch" resultType="com.smartlibrary.domain.DefinedResult">
        <choose>
            <when test="rank_style==0">
                <choose>
                    <when test="book_rank_type==0">
                        <include refid="getDefinedBookRank0"></include>
                    </when>
                    <when test="book_rank_type==1">
                        <include refid="getDefinedBookRank1"></include>
                    </when>
                    <otherwise>
                        <include refid="getDefinedBookRank0"></include>
                    </otherwise>
                </choose>
            </when>
            <when test="rank_style==1">
                <include refid="getDefinedGctrlRank"></include>
            </when>
            <when test="rank_style==2">
                <include refid="getDefinedPrintRank"></include>
            </when>
            <otherwise>
                <choose>
                    <when test="book_rank_type==0">
                        <include refid="getDefinedBookRank0"></include>
                    </when>
                    <when test="book_rank_type==1">
                        <include refid="getDefinedBookRank1"></include>
                    </when>
                    <otherwise>
                        <include refid="getDefinedBookRank0"></include>
                    </otherwise>
                </choose>
            </otherwise>
        </choose>
    </select>
</mapper>