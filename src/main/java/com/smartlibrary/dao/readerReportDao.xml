<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smartlibrary.dao.readerReportDao">
    <!-- 1. 读者姓名、学院、身份-->
    <select id="getReaderInfo" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report">
        select `name`,academy,identity,gender
        from reader_report
        where account=#{account}
    </select>
    <!-- 读者第一次进馆时间、累计进馆次数、到馆次数超过校友百分比（例如：超过87%的校友）-->
    <select id="getReaderGctrlInfo" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report">
        select first_gctr_date,all_gctrl_times,(1-all_gctrl_rank/(select max(all_gctrl_rank) from reader_report)) as per_gctrl_times
        from reader_report
        where account=#{account}
    </select>

    <!-- 读者借阅时间最长的书名及借阅天数、借书总量、借书量排名（如: 排名第87位）-->
    <select id="getReaderBookLendInfo" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report">
        select longgest_book_name,longgest_book_days,all_lend_times,all_lend_rank
        from reader_report
        where account=#{account}
    </select>


    <!-- 借书最多的书籍类别及借阅该类别书籍的总量（如：文学类，共借阅212本），借阅图书最多的月份及该月借阅数量，借阅各类别图书所占百分比（如：经济42%，外语7%…）-->
    <select id="getReaderMaxBookLendInfo" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report2">
        SELECT a.year,a.school,a.account,b.max_book_month,b.max_book_month_count,SUM(A) as 马列主义,SUM(B)as 哲学宗教 ,SUM(C) as 社会科学总论 ,SUM(D) as 政治法律,SUM(E) as 军事,SUM(F) as 经济,SUM(G) as 文教体科,SUM(H) as 语言文字,SUM(I) as 文学,SUM(J) as 艺术,SUM(K) as 历史地理,SUM(N) as 自然科学总论,SUM(O)as 数理化,SUM(P)as 天文地理,SUM(Q)as 生物科学,SUM(R) as 医学卫生,SUM(S) as 农业科学 ,SUM(T) as 工业技术,SUM(U)as 交通运输,SUM(V)as 航空航天,SUM(X) as 环境劳保科学,SUM(Z) as 综合性图书 FROM
    (
        SELECT year,school,account,SUM(A) A,SUM(B) B,SUM(C) C,SUM(D) D,SUM(E) E,SUM(F) F,SUM(G) G,0 H,0 I,0 J,0 K,0 N,0 O,0 P,0 Q,0 R,0 S,0 T,0 U,0 V,0 X,0 Z FROM `reader_report_type1` WHERE account = #{account}
        UNION
        SELECT year,school,account,0 A,0 B,0 C,0 D,0 E,0 F,0 G,SUM(H) H,SUM(I) I,SUM(J) J,SUM(K) K,SUM(N) N,O,P,0 Q,0 R,0 S,0 T,0 U,0 V,0 X,0 Z FROM `reader_report_type2` WHERE account = #{account}
        UNION
        SELECT year,school,account,0 A,0 B,0 C,0 D,0 E,0 F,0 G,0 H,0 I,0 J,0 K,0 N,0 O,0 P,SUM(Q) Q,SUM(R) R,SUM(S) S,SUM(T) T,SUM(U) U,SUM(V) V,SUM(X) X,SUM(Z) Z FROM `reader_report_type3` WHERE account = #{account}
        ) a,reader_report b WHERE a.account = b.account
    </select>


    <!-- 打印页数最多文件的页数及日期、累计文印总量、文印总量排名百分比、文印各类别数量-->
    <select id="getReaderprintInfo" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report">
        select account,max_print_date,max_print_counts,all_printcs_counts,all_printcs_rank,all_print_counts,all_copy_counts,all_scan_counts
        from reader_report
        where account=#{account}
    </select>

    <!-- 座位使用时间最长时长及日期（如：2015年9月16日使用座位4小时）、座位使用总次数、研修间使用总时长-->
    <select id="getReaderDeviceHourInfo" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report">
      select r.account, r.longgset_seat_date,r.all_seat_hours,r.all_seat_times, r.all_croom_hours
      from reader_report r
      where  r.account=#{account}
    </select>

    <!-- 每年座位及研修间使用总时长-->
    <select id="getReaderSeatandcroomInfo" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report">
        select *
        from reader_report_ic_lend
        where  account=#{account}
    </select>


    <!-- 电子阅览室使用时间最长时长及日期、电子阅览室使用总次数、使用总时长-->
    <select id="getReaderEreadHourInfo" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report">
        select r.account,r.longgest_eread_date,r.longgest_eread_hours,r.all_eread_times,r.all_eread_hours
        from reader_report r
        where r.account=#{account}
    </select>
    <!-- 借阅图书使用时间最长书名、时长-->
    <select id="getReaderlonggest_book_name_and_days" parameterType="com.smartlibrary.domain.reader_report" resultType="com.smartlibrary.domain.reader_report">
        SELECT c.account,c.book_name as longgest_book_name ,c.book_no,MAX(days) longgest_book_days FROM (
        SELECT a.account,a.book_name,a.book_no,MIN(a.operation_time) lend,max(b.operation_time) back,DATEDIFF(max(b.operation_time),MIN(a.operation_time)) days
        FROM `z_book_lend_sys` a
        LEFT JOIN z_book_back_sys b
        ON a.book_no = b.book_no
        WHERE a.account = #{account}  AND b.account = #{account} and a.`year` =  #{year} and b.year =  #{year}
        GROUP BY a.book_no) c;
    </select>



    <!-- app需要 全校进馆 借阅排名-->
    <select id="getapp_book_rank" parameterType="com.smartlibrary.domain.reader_report" resultType="Integer">
        SELECT
        count(1)+1
        FROM
        (
        SELECT
        account,
        month_lend_times,
        academy
        FROM
        reader_report
        ) b
        WHERE
        b.month_lend_times > (
        SELECT
        month_lend_times
        FROM
        reader_report
        WHERE
        account = #{account}
        )
    </select>

    <select id="getapp_gctrl_rank" parameterType="com.smartlibrary.domain.reader_report" resultType="Integer">
        SELECT
        count(1)+1
        FROM
        (
        SELECT
        account,
        month_gctrl_times,
        academy
        FROM
        reader_report
        ) b
        WHERE
        b.month_gctrl_times > (
        SELECT
        month_gctrl_times
        FROM
        reader_report
        WHERE
        account = #{account}
        )
    </select>
    <!-- app需要 学院进馆排名-->
    <select id="getapp_gctrl_academy_rank" parameterType="com.smartlibrary.domain.reader_report" resultType="Integer">
       select count(1)from(select account,month_gctrl_times,academy
        from reader_report
        where academy=
        (select academy
        from reader_report
        where account=#{account})) b
        where b.month_gctrl_times>(select month_gctrl_times
        from reader_report
        where account=#{account})
    </select>


    <!-- app需要 学院借阅排名-->
    <select id="getapp_book_academy_rank" parameterType="com.smartlibrary.domain.reader_report" resultType="Integer">
        select count(1)from(select account,month_lend_times,academy
        from reader_report
        where academy=
        (select academy
        from reader_report
        where account=#{account})) b
        where b.month_lend_times>(select month_lend_times
        from reader_report
        where account=#{account})
    </select>

</mapper>